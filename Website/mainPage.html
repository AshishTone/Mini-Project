<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>MedBox Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="styles.css">
  <style>
    .modal {
      display: none;
      position: fixed;
      z-index: 999;
      left: 0;
      top: 0;
      width: 100%;
      height: 100%;
      overflow: auto;
      backdrop-filter: blur(5px);
      background-color: rgba(0, 0, 0, 0.3);
    }

    .modal-content {
      background-color: white;
      margin: 5% auto;
      padding: 20px;
      border-radius: 12px;
      width: 50%;
      box-shadow: 0 5px 15px rgba(0,0,0,0.3);
      position: relative;
    }

    .close {
      position: absolute;
      right: 15px;
      top: 10px;
      font-size: 24px;
      cursor: pointer;
    }

    .form-group {
      margin-bottom: 15px;
    }

    input, label, select, textarea {
      display: block;
      width: 100%;
    }

    input, select, textarea {
      padding: 8px;
      margin-top: 5px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    button[type="submit"] {
      background-color: #00796b;
      color: white;
      padding: 10px;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      width: 100%;
      margin-top: 10px;
    }

    button[type="submit"]:hover {
      background-color: #004d40;
    }

    .search-container {
      width: 100%;
      max-width: 400px;
      margin: 10px auto;
    }

    #searchInput {
      width: 100%;
      padding: 8px;
      border: 1px solid #ccc;
      border-radius: 6px;
    }

    /* Animation for reminder popup */
    @keyframes slideIn {
      from { transform: translateY(50px); opacity: 0; }
      to { transform: translateY(0); opacity: 1; }
    }

    .reminder-popup {
      animation: slideIn 0.3s ease-out;
    }

    /* Tooltip for notes */
    .tooltip {
      position: relative;
      display: inline-block;
    }

    .tooltip .tooltiptext {
      visibility: hidden;
      width: 200px;
      background-color: #555;
      color: #fff;
      text-align: center;
      border-radius: 6px;
      padding: 5px;
      position: absolute;
      z-index: 1;
      bottom: 125%;
      left: 50%;
      margin-left: -100px;
      opacity: 0;
      transition: opacity 0.3s;
    }

    .tooltip:hover .tooltiptext {
      visibility: visible;
      opacity: 1;
    }
  </style>
</head>
<body class="bg-gray-50 text-gray-800">

  <header>
    <div class="logo">
      <h1>
        <a href="index.html"><strong>RemindDose</strong><sub class="sub">(A Medicine Management System)</sub></a>
      </h1>
    </div>
    <nav>
      <a href="#New">New Medicine</a>
      <a href="#Dashboard">Dashboard</a>
      <a href="#Reminder">Set Reminder</a>
      <a href="#Import" onclick="openImportModal()">Import</a>
      <a href="index.html" class="btn" id="authButton">Signout/Logout</a>    
    </nav>
    <div class="hamburger" onclick="toggleMenu()">
      <span></span><span></span><span></span>
    </div>
    <div class="mobile-menu" id="mobileMenu">
      <a href="#New">New Medicine</a>
      <a href="#Dashboard">Dashboard</a>
      <a href="#Reminder">Set Reminder</a>
      <a href="#Import" onclick="openImportModal()">Import</a>
    </div>
  </header>

  <!-- Search Bar -->
  <div class="search-container">
    <input type="text" id="searchInput" placeholder="Search medicines..." onkeyup="searchMedicines()">
  </div>

<main class="max-w-6xl mx-auto px-6 py-8 space-y-6" id="mainContent">
    <!-- Top Cards -->
    <div class="grid grid-cols-1 md:grid-cols-3 gap-4" id="Dashboard">
      <!-- Today's Medicines -->
      <div class="bg-white rounded-lg p-4 shadow">
        <div class="flex justify-between items-center mb-2">
          <h2 class="font-semibold">Today's Medicines</h2>
          <span class="text-sm text-blue-500" id="todayCount">0 remaining</span>
        </div>
        <div class="space-y-2" id="todayMedicines">
          <!-- Will be populated by JavaScript -->
        </div>
      </div>

      <!-- Expiring Soon -->
      <div class="bg-white rounded-lg p-4 shadow">
        <div class="flex justify-between items-center mb-2">
          <h2 class="font-semibold">Expiring Soon</h2>
          <span class="text-sm text-orange-500" id="expiringCount">0 medicines</span>
        </div>
        <div class="space-y-2" id="expiringMedicines">
          <!-- Will be populated by JavaScript -->
        </div>
      </div>

      <!-- Upcoming Refills -->
      <div class="bg-white rounded-lg p-4 shadow">
        <div class="flex justify-between items-center mb-2">
          <h2 class="font-semibold">Upcoming Refills</h2>
          <span class="text-sm text-blue-400" id="refillCount">0 medicines</span>
        </div>
        <div class="space-y-2" id="refillMedicines">
          <!-- Will be populated by JavaScript -->
        </div>
      </div>
    </div>

    <!-- Medicine Categories -->
    <div>
      <h2 class="text-lg font-semibold mb-3">Medicine Categories</h2>
      <div class="grid grid-cols-1 md:grid-cols-5 gap-4" id="medicineCategories">
        <!-- Category Cards will be populated by JavaScript -->
        <div class="bg-white p-4 rounded shadow">
          <p class="font-medium text-yellow-500">☀ Morning</p>
          <p class="text-sm text-gray-500" id="morningCount">0 medicines</p>
          <p class="text-sm text-gray-500">8:00 AM - 10:00 AM</p>
          <div id="morningMeds">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>
        <div class="bg-white p-4 rounded shadow">
          <p class="font-medium text-orange-400">🌤 Afternoon</p>
          <p class="text-sm text-gray-500" id="afternoonCount">0 medicines</p>
          <p class="text-sm text-gray-500">2:00 PM - 4:00 PM</p>
          <div id="afternoonMeds">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>
        <div class="bg-white p-4 rounded shadow">
          <p class="font-medium text-indigo-700">🌙 Evening</p>
          <p class="text-sm text-gray-500" id="eveningCount">0 medicines</p>
          <p class="text-sm text-gray-500">6:00 PM - 8:00 PM</p>
          <div id="eveningMeds">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>
        <div class="bg-white p-4 rounded shadow">
          <p class="font-medium text-purple-700">🛌 Bedtime</p>
          <p class="text-sm text-gray-500" id="bedtimeCount">0 medicines</p>
          <p class="text-sm text-gray-500">9:00 PM - 10:00 PM</p>
          <div id="bedtimeMeds">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>
        <div class="bg-white p-4 rounded shadow">
          <p class="font-medium text-green-600">💊 General Medicine</p>
          <p class="text-sm text-gray-500" id="generalCount">0 medicines</p>
          <p class="text-sm text-gray-500">All Medicines</p>
          <div id="generalMeds">
            <!-- Will be populated by JavaScript -->
          </div>
        </div>
      </div>
    </div>

    <!-- Buttons -->
    <div class="grid grid-cols-1 md:grid-cols-2 gap-4 p-6 rounded shadow">
      <div class="bg-white p-4 rounded shadow flex items-center justify-between">
        <div id="New">
          <p class="text-blue-400 text-2xl">➕</p>
          <p class="text-sm mt-2 font-medium">Add New Medicine</p>
          <p class="text-xs text-gray-500">Track a new medication</p>
        </div>
        <button onclick="openAddMedicineModal()" class="bg-white text-green-600 border border-green-300 px-4 py-2 rounded">Add Medicine</button>
      </div>

      <div class="bg-white p-4 rounded shadow flex items-center justify-between">
        <div id="Reminder">
          <p class="text-blue-400 text-2xl">🔔</p>
          <p class="text-sm mt-2 font-medium">Set Reminder</p>
          <p class="text-xs text-gray-500">Create a new reminder schedule</p>
        </div>
        <button onclick="openReminderModal()" class="bg-white text-green-600 border border-green-300 px-4 py-2 rounded">Set Reminder</button>
      </div>
    </div>
  </main>

  <!-- Footer -->
  <div id="aboutOverlay" style="
    position:fixed;
    top:0; left:0;
    width:100%; height:100%;
    display:none;
    justify-content:center;
    align-items:center;
    backdrop-filter:blur(5px);
    background-color:rgba(0,0,0,0.3);
    z-index:1000;
  ">
    <div style="
      background:white;
      padding:20px 30px;
      border-radius:10px;
      width:300px;
      box-shadow:0 5px 15px rgba(0,0,0,0.3);
      text-align:center;
      position:relative;
    ">
      <span onclick="closeAbout()" style="
        position:absolute;
        top:10px;
        right:15px;
        font-size:20px;
        cursor:pointer;
      ">&times;</span>
      <h2>About Us</h2>
      <p>We help users manage their medicines with daily reminders and expiry alerts, making health management simple and stress-free.</p>
    </div>
  </div>

  <footer>
    <div>
      <h4>RemindDose</h4>
    </div>
    <div>
      <h3>Quick Links</h3>
      <a onclick="openAbout()" style="color:rgb(94, 169, 244) !important; font-size:18px;cursor: pointer;">About</a>
    </div>
  </footer>

  <!-- Import Modal -->
  <div class="modal" id="importModal">
    <div class="modal-content">
      <span class="close" onclick="closeImportModal()">&times;</span>
      <h2 class="text-xl font-semibold mb-4">Import Medicines and Reminders</h2>
      <div class="max-w-xl mx-auto bg-white p-6 rounded-lg shadow-md space-y-4">
        <div>
          <label class="block mb-1 font-medium">Select File to Import</label>
          <input type="file" id="importFile" accept=".txt" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <button type="button" onclick="importFromFile()" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 transition">Import Data</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Refill Modal -->
  <div class="modal" id="refillModal">
    <div class="modal-content">
      <span class="close" onclick="closeRefillModal()">&times;</span>
      <h2 class="text-xl font-semibold mb-4">Refill Medicine</h2>
      <div class="max-w-xl mx-auto bg-white p-6 rounded-lg shadow-md space-y-4">
        <div>
          <label class="block mb-1 font-medium">Medicine Name</label>
          <p id="refillMedicineName" class="font-medium"></p>
        </div>
        <div>
          <label class="block mb-1 font-medium">Current Quantity</label>
          <p id="refillCurrentQuantity" class="font-medium"></p>
        </div>
        <div>
          <label class="block mb-1 font-medium">Add Quantity</label>
          <input type="number" id="refillAddQuantity" min="1" value="1" class="w-full border rounded px-3 py-2">
        </div>
        <div>
          <button type="button" onclick="saveRefill()" class="w-full bg-green-600 text-white py-2 rounded hover:bg-blue-700 transition">Save Refill</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Reminder Modal -->
  <div class="modal" id="reminderModal">
    <div class="modal-content">
      <span class="close" onclick="closeReminderModal()">&times;</span>
      <h2 class="text-xl font-semibold mb-4">Set Reminder</h2>
        <!-- Select Medicine -->
        <div>
          <label class="block mb-1 font-medium">Select Medicine</label>
          <select id="reminderMedicineSelect" class="w-full border rounded px-3 py-2">
            <option value="">Choose medicine from your list</option>
            <!-- Options will be populated by JavaScript -->
          </select>
        </div>
    
        <!-- Dosage -->
        <div>
          <label class="block mb-1 font-medium">Dosage</label>
          <div class="flex space-x-2 items-center">
            <button type="button" class="px-3 py-1 border rounded" onclick="adjustDosage('decrease')">−</button>
            <input type="number" id="dosageAmount" value="1" class="w-16 border rounded px-2 py-1 text-center" min="1" />
            <select id="dosageUnit" class="border rounded px-3 py-1">
              <option>tablet(s)</option>
              <option>ml</option>
              <option>capsule(s)</option>
            </select>
          </div>
        </div>
    
        <!-- Reminder Times -->
        <div>
          <label class="block mb-1 font-medium">Reminder Times</label>
          <div id="reminderTimesContainer">
            <div class="flex items-center space-x-2 mb-2">
              <input type="time" value="08:00" class="border rounded px-3 py-2 w-32 reminder-time" />
              <button type="button" class="text-green-600 text-xl font-bold" onclick="addReminderTimeField()" >+</button>
            </div>
          </div>
        </div>
    
        <!-- Repeat -->
        <div>
          <label class="block mb-1 font-medium">Repeat</label>
          <div class="flex space-x-2">
            <button type="button" class="px-4 py-1 rounded-full border text-green-600 bg-green-100" onclick="setRepeat('daily')">Daily</button>
            <button type="button" class="px-4 py-1 rounded-full border" onclick="setRepeat('weekly')">Weekly</button>
            <button type="button" class="px-4 py-1 rounded-full border" onclick="setRepeat('alternate')">Alternate Days</button>
          </div>
          <input type="hidden" id="repeatType" value="daily">
        </div>
    
        <!-- Start and End Dates -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
          <div>
            <label class="block mb-1 font-medium">Start Date</label>
            <input type="date" id="startDate" class="w-full border rounded px-3 py-2" />
          </div>
          <div>
            <label class="block mb-1 font-medium">End Date</label>
            <input type="date" id="endDate" class="w-full border rounded px-3 py-2" />
          </div>
        </div>
    
        <!-- Notes -->
        <div>
          <label class="block mb-1 font-medium">Notes (Optional)</label>
          <textarea id="reminderNotes" class="w-full border rounded px-3 py-2" placeholder="Add any special instructions (e.g., Take with food)" style="margin-bottom: 10px;"></textarea>
        </div>
    
        <!-- Save Button -->
        <div>
          <button type="button" onclick="saveReminder()" class=" saveReminder w-full bg-white text-black-600 border border-green-300 px-4 py-2 rounded hover:color-green" style="padding-top: 10px !important; background-color: rgb(111, 189, 82); ">Save Reminder</button>
        </div>
    </div>
  </div>

  <!-- Reminder Popup -->
  <div class="modal" id="reminderPopup">
    <div class="modal-content reminder-popup" style="width: 350px;">
      <span class="close" onclick="closeReminderPopup()">&times;</span>
      <h2 class="text-xl font-semibold mb-2">⏰ Reminder</h2>
      <div id="reminderPopupContent" class="space-y-2">
        <!-- Content will be populated by JavaScript -->
      </div>
      <div class="mt-4">
        <button onclick="closeReminderPopup()" class="w-full bg-green-600 text-white py-2 rounded hover:bg-green-700 transition">OK</button>
      </div>
    </div>
  </div>

  <!-- Add Medicine Modal -->
  <div class="modal" id="addMedicineModal">
    <div class="modal-content">
      <span class="close" onclick="closeAddMedicineModal()">&times;</span>
      <h2>Add Medicine</h2>
    <form id="medicineForm" onsubmit="event.preventDefault(); saveMedicine();">
      <div class="form-group">
        <label for="name">Medicine Name *</label>
        <input type="text" id="name" name="name" required />
      </div>
      <div class="form-group">
        <label for="category">Category</label>
        <select id="category" name="category" class="w-full border rounded px-3 py-2">
          <option value="morning">☀ Morning</option>
          <option value="afternoon">🌤 Afternoon</option>
          <option value="evening">🌙 Evening</option>
          <option value="bedtime">🛌 Bedtime</option>
          <option value="general">💊 General Medicine</option>
        </select>
      </div>
      <div class="form-group">
        <label for="mfg">Date of Manufacture *</label>
        <input type="date" id="mfg" name="manufactureDate" required />
      </div>
      <div class="form-group">
        <label for="expiry">Date of Expiry *</label>
        <input type="date" id="expiry" name="expiryDate" required />
      </div>
      <div class="form-group">
        <label for="dosage">Dosage</label>
        <input type="text" id="dosage" name="dosage" />
      </div>
      <div class="form-group">
        <label for="quantity">Quantity *</label>
        <input type="number" id="quantity" name="quantity" min="1" required />
      </div>
      <button type="submit" class="bg-white text-green-600 border border-green-300 px-4 py-2 rounded" style="background-color: rgb(111, 189, 82) !important;">Add Medicine</button>
    </form>
    </div>
  </div>

  <!-- Scripts -->
  <script>

// Add Medicine Modal functions
function openAddMedicineModal() {
    document.getElementById("addMedicineModal").style.display = "block";
    document.getElementById("mainContent").style.filter = "blur(5px)";
    // Reset form
    document.getElementById("medicineForm").reset();
    // Set default expiry date to 1 year from now
    const today = new Date();
    const oneYearLater = new Date(today.setFullYear(today.getFullYear() + 1)).toISOString().split('T')[0];
    document.getElementById('expiry').value = oneYearLater;
    // Set manufacture date to today
    document.getElementById('mfg').value = new Date().toISOString().split('T')[0];
  }

  function closeAddMedicineModal() {
    document.getElementById("addMedicineModal").style.display = "none";
    document.getElementById("mainContent").style.filter = "none";
  }

  function saveMedicine() {
    const name = document.getElementById('name').value;
    const category = document.getElementById('category').value;
    const mfg = document.getElementById('mfg').value;
    const expiry = document.getElementById('expiry').value;
    const dosage = document.getElementById('dosage').value;
    const quantity = document.getElementById('quantity').value;
    
    if (!name || !mfg || !expiry || !quantity) {
      alert('Please fill all required fields');
      return;
    }
    
    const medicines = JSON.parse(localStorage.getItem('medicines')) || [];
    const newMedicine = {
      id: medicines.length > 0 ? Math.max(...medicines.map(m => m.id)) + 1 : 1,
      name,
      category,
      mfg,
      expiry,
      dosage,
      quantity: parseInt(quantity)
    };
    
    medicines.push(newMedicine);
    localStorage.setItem('medicines', JSON.stringify(medicines));
    
    // Update UI
    updateDashboard();
    closeAddMedicineModal();
    alert('Medicine added successfully!');
  }

  // Set Reminder Modal functions
  function openReminderModal() {
    document.getElementById("reminderModal").style.display = "block";
    document.getElementById("mainContent").style.filter = "blur(5px)";
    populateMedicineDropdown();
    // Set default dates
    const today = new Date().toISOString().split('T')[0];
    document.getElementById('startDate').value = today;
    document.getElementById('endDate').value = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
    // Reset form
    document.getElementById('reminderMedicineSelect').selectedIndex = 0;
    document.getElementById('dosageAmount').value = 1;
    document.getElementById('dosageUnit').selectedIndex = 0;
    document.getElementById('reminderTimesContainer').innerHTML = `
      <div class="flex items-center space-x-2 mb-2">
        <input type="time" value="08:00" class="border rounded px-3 py-2 w-32 reminder-time" />
        <button type="button" class="text-blue-600 text-xl font-bold" onclick="addReminderTimeField()">+</button>
      </div>
    `;
    document.getElementById('repeatType').value = "daily";
    document.getElementById('reminderNotes').value = "";
  }

  function closeReminderModal() {
    document.getElementById("reminderModal").style.display = "none";
    document.getElementById("mainContent").style.filter = "none";
  }

  // Import Modal functions
  function openImportModal() {
    document.getElementById("importModal").style.display = "block";
    document.getElementById("mainContent").style.filter = "blur(5px)";
    // Reset file input
    document.getElementById('importFile').value = '';
  }

  function closeImportModal() {
    document.getElementById("importModal").style.display = "none";
    document.getElementById("mainContent").style.filter = "none";
  }






































    // Initialize empty data if not exists
    if (!localStorage.getItem('medicines')) {
      localStorage.setItem('medicines', JSON.stringify([]));
    }

    if (!localStorage.getItem('reminders')) {
      localStorage.setItem('reminders', JSON.stringify([]));
    }

    // Check if user is logged in (simplified)
    function checkAuthStatus() {
      const authButton = document.getElementById('authButton');
      authButton.textContent = 'Signout/Logout';
      authButton.onclick = function() {
        localStorage.removeItem('isLoggedIn');
        window.location.href = 'index.html';
      };
    }

    // Toggle mobile menu
    function toggleMenu() {
      const menu = document.getElementById('mobileMenu');
      menu.style.display = menu.style.display === 'flex' ? 'none' : 'flex';
    }

    // About modal functions
    function openAbout() {
      document.getElementById('aboutOverlay').style.display = 'flex';
    }

    function closeAbout() {
      document.getElementById('aboutOverlay').style.display = 'none';
    }

    // Import modal functions
    function openImportModal() {
      document.getElementById("importModal").style.display = "block";
      document.getElementById("mainContent").style.filter = "blur(5px)";
    }

    function closeImportModal() {
      document.getElementById("importModal").style.display = "none";
      document.getElementById("mainContent").style.filter = "none";
    }

    function importFromFile() {
      const fileInput = document.getElementById('importFile');
      const file = fileInput.files[0];
      
      if (!file) {
        alert('Please select a file to import');
        return;
      }
      
      const reader = new FileReader();
      reader.onload = function(e) {
        try {
          const content = e.target.result;
          // Parse the content and add to local storage
          // This is a simplified parser - you may need to adjust based on your file format
          const lines = content.split('\n');
          let currentMedicine = null;
          let currentReminder = null;
          
          for (const line of lines) {
            if (line.startsWith('Name:')) {
              currentMedicine = {
                name: line.substring(5).trim(),
                category: 'general',
                mfg: new Date().toISOString().split('T')[0],
                expiry: new Date(Date.now() + 365 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                dosage: '',
                quantity: 10
              };
            } else if (line.startsWith('Category:')) {
              if (currentMedicine) currentMedicine.category = line.substring(9).trim().toLowerCase();
            } else if (line.startsWith('Manufacture:')) {
              if (currentMedicine) currentMedicine.mfg = line.substring(12).trim();
            } else if (line.startsWith('Expiry:')) {
              if (currentMedicine) currentMedicine.expiry = line.substring(7).trim();
            } else if (line.startsWith('Dosage:')) {
              if (currentMedicine) currentMedicine.dosage = line.substring(7).trim();
            } else if (line.startsWith('Quantity:')) {
              if (currentMedicine) currentMedicine.quantity = parseInt(line.substring(9).trim());
            } else if (line.startsWith('Medicine:')) {
              currentReminder = {
                medicineName: line.substring(9).trim(),
                dosage: '1 tablet(s)',
                times: ['08:00'],
                repeat: 'daily',
                startDate: new Date().toISOString().split('T')[0],
                endDate: new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0],
                notes: ''
              };
            } else if (line.startsWith('Times:')) {
              if (currentReminder) currentReminder.times = line.substring(6).trim().split(', ');
            } else if (line.startsWith('Repeat:')) {
              if (currentReminder) currentReminder.repeat = line.substring(7).trim();
            } else if (line.startsWith('Start:')) {
              if (currentReminder) currentReminder.startDate = line.substring(6).trim();
            } else if (line.startsWith('End:')) {
              if (currentReminder) currentReminder.endDate = line.substring(4).trim();
            } else if (line.startsWith('Notes:')) {
              if (currentReminder) currentReminder.notes = line.substring(6).trim();
            } else if (line.trim() === '' && currentMedicine) {
              // Save the current medicine
              const medicines = JSON.parse(localStorage.getItem('medicines')) || [];
              const existingIndex = medicines.findIndex(m => m.name === currentMedicine.name);
              
              if (existingIndex === -1) {
                currentMedicine.id = medicines.length > 0 ? Math.max(...medicines.map(m => m.id)) + 1 : 1;
                medicines.push(currentMedicine);
                localStorage.setItem('medicines', JSON.stringify(medicines));
              }
              
              currentMedicine = null;
            } else if (line.trim() === '' && currentReminder) {
              // Save the current reminder
              const reminders = JSON.parse(localStorage.getItem('reminders')) || [];
              const medicines = JSON.parse(localStorage.getItem('medicines')) || [];
              const medicine = medicines.find(m => m.name === currentReminder.medicineName);
              
              if (medicine) {
                const existingIndex = reminders.findIndex(r => 
                  r.medicineId === medicine.id && 
                  r.times.join(',') === currentReminder.times.join(','));
                
                if (existingIndex === -1) {
                  currentReminder.id = reminders.length > 0 ? Math.max(...reminders.map(r => r.id)) + 1 : 1;
                  currentReminder.medicineId = medicine.id;
                  reminders.push(currentReminder);
                  localStorage.setItem('reminders', JSON.stringify(reminders));
                }
              }
              
              currentReminder = null;
            }
          }
          
          updateDashboard();
          closeImportModal();
          alert('Data imported successfully!');
        } catch (error) {
          console.error('Error importing file:', error);
          alert('Error importing file. Please check the file format.');
        }
      };
      reader.readAsText(file);
    }

    // Refill modal functions
    let currentRefillMedicineId = null;

    function openRefillModal(medicineId) {
      const medicines = JSON.parse(localStorage.getItem('medicines')) || [];
      const medicine = medicines.find(m => m.id === medicineId);
      
      if (medicine) {
        currentRefillMedicineId = medicineId;
        document.getElementById('refillMedicineName').textContent = medicine.name;
        document.getElementById('refillCurrentQuantity').textContent = medicine.quantity;
        document.getElementById('refillAddQuantity').value = 1;
        document.getElementById("refillModal").style.display = "block";
        document.getElementById("mainContent").style.filter = "blur(5px)";
      }
    }

    function closeRefillModal() {
      document.getElementById("refillModal").style.display = "none";
      document.getElementById("mainContent").style.filter = "none";
      currentRefillMedicineId = null;
    }

    function saveRefill() {
      if (!currentRefillMedicineId) return;
      
      const addQuantity = parseInt(document.getElementById('refillAddQuantity').value);
      if (isNaN(addQuantity) ){
        alert('Please enter a valid quantity');
        return;
      }
      
      const medicines = JSON.parse(localStorage.getItem('medicines')) || [];
      const medicineIndex = medicines.findIndex(m => m.id === currentRefillMedicineId);
      
      if (medicineIndex !== -1) {
        medicines[medicineIndex].quantity += addQuantity;
        localStorage.setItem('medicines', JSON.stringify(medicines));
        updateDashboard();
        closeRefillModal();
        alert('Medicine refilled successfully!');
      }
    }

    // Reminder modal functions
    function openReminderModal() {
      document.getElementById("reminderModal").style.display = "block";
      document.getElementById("mainContent").style.filter = "blur(5px)";
      populateMedicineDropdown();
      // Set default dates
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('startDate').value = today;
      document.getElementById('endDate').value = new Date(Date.now() + 30 * 24 * 60 * 60 * 1000).toISOString().split('T')[0];
    }

    function closeReminderModal() {
      document.getElementById("reminderModal").style.display = "none";
      document.getElementById("mainContent").style.filter = "none";
    }

    function addReminderTimeField() {
      const container = document.getElementById('reminderTimesContainer');
      const newTimeField = document.createElement('div');
      newTimeField.className = 'flex items-center space-x-2 mb-2';
      newTimeField.innerHTML = `
        <input type="time" value="08:00" class="border rounded px-3 py-2 w-32 reminder-time" />
        <button type="button" class="text-red-600 text-xl font-bold" onclick="this.parentNode.remove()">−</button>
      `;
      container.appendChild(newTimeField);
    }

    function setRepeat(type) {
      document.getElementById('repeatType').value = type;
      // Update button styles
      const buttons = document.querySelectorAll('#reminderModal button[onclick^="setRepeat"]');
      buttons.forEach(btn => {
        if (btn.getAttribute('onclick').includes(type)) {
          btn.classList.add('text-green-600', 'bg-green-100');
        } else {
          btn.classList.remove('text-green-600', 'bg-green-100');
        }
      });
    }

    function adjustDosage(action) {
      const dosageInput = document.getElementById('dosageAmount');
      let value = parseInt(dosageInput.value);
      if (action === 'increase') {
        dosageInput.value = value + 1;
      } else if (action === 'decrease' && value > 1) {
        dosageInput.value = value - 1;
      }
    }

    function populateMedicineDropdown() {
      const medicines = JSON.parse(localStorage.getItem('medicines')) || [];
      const select = document.getElementById('reminderMedicineSelect');
      // Clear existing options except the first one
      while (select.options.length > 1) {
        select.remove(1);
      }
      
      medicines.forEach(medicine => {
        const option = document.createElement('option');
        option.value = medicine.id;
        option.textContent = medicine.name;
        select.appendChild(option);
      });
    }

    function saveReminder() {
      const medicineId = document.getElementById('reminderMedicineSelect').value;
      if (!medicineId) {
        alert('Please select a medicine');
        return;
      }
      
      const medicines = JSON.parse(localStorage.getItem('medicines')) || [];
      const selectedMedicine = medicines.find(m => m.id == medicineId);
      
      const dosageAmount = document.getElementById('dosageAmount').value;
      const dosageUnit = document.getElementById('dosageUnit').value;
      const dosage = `${dosageAmount} ${dosageUnit}`;
      
      const timeInputs = document.querySelectorAll('.reminder-time');
      const times = Array.from(timeInputs).map(input => input.value);
      
      const repeat = document.getElementById('repeatType').value;
      const startDate = document.getElementById('startDate').value;
      const endDate = document.getElementById('endDate').value;
      const notes = document.getElementById('reminderNotes').value;
      
      const reminders = JSON.parse(localStorage.getItem('reminders')) || [];
      const newReminder = {
        id: reminders.length > 0 ? Math.max(...reminders.map(r => r.id)) + 1 : 1,
        medicineId: parseInt(medicineId),
        medicineName: selectedMedicine.name,
        dosage,
        times,
        repeat,
        startDate,
        endDate,
        notes
      };
      
      reminders.push(newReminder);
      localStorage.setItem('reminders', JSON.stringify(reminders));
      
      // Update UI
      updateDashboard();
      closeReminderModal();
      alert('Reminder saved successfully!');
    }

    // Add Medicine modal functions
    function openAddMedicineModal() {
      document.getElementById("addMedicineModal").style.display = "block";
      document.getElementById("mainContent").style.filter = "blur(5px)";
      // Set default expiry date to 1 year from now
      const today = new Date();
      const oneYearLater = new Date(today.setFullYear(today.getFullYear() + 1)).toISOString().split('T')[0];
      document.getElementById('expiry').value = oneYearLater;
      // Set manufacture date to today
      document.getElementById('mfg').value = new Date().toISOString().split('T')[0];
    }

    function closeAddMedicineModal() {
      document.getElementById("addMedicineModal").style.display = "none";
      document.getElementById("mainContent").style.filter = "none";
    }

    function saveMedicine() {
      const name = document.getElementById('name').value;
      const category = document.getElementById('category').value;
      const mfg = document.getElementById('mfg').value;
      const expiry = document.getElementById('expiry').value;
      const dosage = document.getElementById('dosage').value;
      const quantity = document.getElementById('quantity').value;
      
      if (!name || !mfg || !expiry || !quantity) {
        alert('Please fill all required fields');
        return;
      }
      
      const medicines = JSON.parse(localStorage.getItem('medicines')) || [];
      const newMedicine = {
        id: medicines.length > 0 ? Math.max(...medicines.map(m => m.id)) + 1 : 1,
        name,
        category,
        mfg,
        expiry,
        dosage,
        quantity: parseInt(quantity)
      };
      
      medicines.push(newMedicine);
      localStorage.setItem('medicines', JSON.stringify(medicines));
      
      // Update UI
      updateDashboard();
      closeAddMedicineModal();
      alert('Medicine added successfully!');
    }

    // Reminder popup functions
    function openReminderPopup(reminder) {
      const medicines = JSON.parse(localStorage.getItem('medicines')) || [];
      const medicine = medicines.find(m => m.id === reminder.medicineId);
      
      if (medicine) {
        const popupContent = document.getElementById('reminderPopupContent');
        popupContent.innerHTML = `
          <p class="font-medium">${medicine.name} (${reminder.dosage})</p>
          <p class="text-sm text-gray-600">Time: ${reminder.times.join(', ')}</p>
          ${reminder.notes ? `<p class="text-sm text-gray-600">Notes: ${reminder.notes}</p>` : ''}
        `;
        
        document.getElementById("reminderPopup").style.display = "block";
        document.getElementById("mainContent").style.filter = "blur(5px)";
      }
    }

    function closeReminderPopup() {
      document.getElementById("reminderPopup").style.display = "none";
      document.getElementById("mainContent").style.filter = "none";
    }

    // Check for reminders that need to be shown
    function checkForReminders() {
      const now = new Date();
      const currentTime = `${String(now.getHours()).padStart(2, '0')}:${String(now.getMinutes()).padStart(2, '0')}`;
      
      const reminders = JSON.parse(localStorage.getItem('reminders')) || [];
      const today = new Date().toISOString().split('T')[0];
      
      const activeReminders = reminders.filter(reminder => {
        return reminder.startDate <= today && 
               reminder.endDate >= today && 
               reminder.times.includes(currentTime);
      });
      
      if (activeReminders.length > 0) {
        openReminderPopup(activeReminders[0]);
      }
    }

        // Search functionality
    function searchMedicines() {
      const searchTerm = document.getElementById('searchInput').value.toLowerCase();
      if (!searchTerm) {
        updateDashboard();
        return;
      }
      
      const medicines = JSON.parse(localStorage.getItem('medicines')) || [];
      const filteredMedicines = medicines.filter(medicine => 
        medicine.name.toLowerCase().includes(searchTerm) || 
        medicine.category.toLowerCase().includes(searchTerm) ||
        (medicine.dosage && medicine.dosage.toLowerCase().includes(searchTerm))
      );
      
      // Update UI with search results
      updateDashboard(filteredMedicines);
    }

    // Update dashboard with data
    function updateDashboard(filteredMedicines = null) {
      const medicines = filteredMedicines || JSON.parse(localStorage.getItem('medicines')) || [];
      const reminders = JSON.parse(localStorage.getItem('reminders')) || [];
      
      // Update Today's Medicines
      const todayMedicines = document.getElementById('todayMedicines');
      todayMedicines.innerHTML = '';
      
      const today = new Date().toISOString().split('T')[0];
      const todayReminders = reminders.filter(r => r.startDate <= today && r.endDate >= today);
      
      document.getElementById('todayCount').textContent = `${todayReminders.length} remaining`;
      
      todayReminders.forEach(reminder => {
        const medicine = medicines.find(m => m.id === reminder.medicineId);
        if (medicine) {
          const reminderDiv = document.createElement('div');
          reminderDiv.className = 'bg-gray-100 p-3 rounded flex justify-between tooltip';
          reminderDiv.innerHTML = `
            <div>
              <p class="font-medium">${medicine.name}</p>
              <p class="text-sm text-gray-500">${reminder.dosage} - ${reminder.times.join(', ')}</p>
            </div>
            ${reminder.notes ? `<span class="tooltiptext">${reminder.notes}</span>` : ''}
          `;
          todayMedicines.appendChild(reminderDiv);
        }
      });
      
      // Update Expiring Soon (20 days or less)
      const expiringMedicines = document.getElementById('expiringMedicines');
      expiringMedicines.innerHTML = '';
      
      const soonExpiring = medicines.filter(medicine => {
        const expiryDate = new Date(medicine.expiry);
        const today = new Date();
        const diffTime = expiryDate - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        return diffDays <= 20 && diffDays >= 0;
      });
      
      document.getElementById('expiringCount').textContent = `${soonExpiring.length} medicines`;
      
      soonExpiring.forEach(medicine => {
        const expiryDate = new Date(medicine.expiry);
        const today = new Date();
        const diffTime = expiryDate - today;
        const diffDays = Math.ceil(diffTime / (1000 * 60 * 60 * 24));
        
        const medicineDiv = document.createElement('div');
        medicineDiv.className = 'bg-orange-50 p-3 rounded';
        medicineDiv.innerHTML = `
          <p class="font-medium text-orange-700">⚠ ${medicine.name}</p>
          <p class="text-sm text-gray-600">Expires in ${diffDays} days</p>
        `;
        expiringMedicines.appendChild(medicineDiv);
      });
      
      // Update Upcoming Refills (quantity <= 4)
      const refillMedicines = document.getElementById('refillMedicines');
      refillMedicines.innerHTML = '';
      
      const lowQuantity = medicines.filter(medicine => medicine.quantity <= 4);
      
      document.getElementById('refillCount').textContent = `${lowQuantity.length} medicines`;
      
      lowQuantity.forEach(medicine => {
        const medicineDiv = document.createElement('div');
        medicineDiv.className = 'bg-blue-50 p-3 rounded flex justify-between items-center';
        medicineDiv.innerHTML = `
          <div>
            <p class="font-medium text-blue-700">${medicine.name}</p>
            <p class="text-sm text-gray-600">${medicine.quantity} remaining</p>
          </div>
          <button onclick="openRefillModal(${medicine.id})" class="text-sm bg-blue-100 text-green-700 px-2 py-1 rounded">Refill</button>
        `;
        refillMedicines.appendChild(medicineDiv);
      });
      
      // Update Medicine Categories
      const categories = ['morning', 'afternoon', 'evening', 'bedtime', 'general'];
      categories.forEach(category => {
        const categoryMedicines = medicines.filter(m => m.category === category);
        document.getElementById(`${category}Count`).textContent = `${categoryMedicines.length} ${categoryMedicines.length === 1 ? 'medicine' : 'medicines'}`;
        
        const medsContainer = document.getElementById(`${category}Meds`);
        medsContainer.innerHTML = '';
        
        categoryMedicines.forEach(medicine => {
          const medElement = document.createElement('p');
          medElement.className = 'mt-2 text-sm';
          medElement.textContent = medicine.name;
          medsContainer.appendChild(medElement);
        });
      });
      document.getElementById('generalCount').textContent = `${medicines.length} ${medicines.length === 1 ? 'medicine' : 'medicines'}`;
const generalMedsContainer = document.getElementById('generalMeds');
generalMedsContainer.innerHTML = '';

medicines.forEach(medicine => {
  const medElement = document.createElement('p');
  medElement.className = 'mt-2 text-sm';
  medElement.textContent = medicine.name;
  generalMedsContainer.appendChild(medElement);
});
    }

    // Save data to files
    function saveMedicinesToFile() {
      const medicines = JSON.parse(localStorage.getItem('medicines')) || [];
      const content = medicines.map(med => 
        `Name: ${med.name}\nCategory: ${med.category}\nManufacture: ${med.mfg}\nExpiry: ${med.expiry}\nDosage: ${med.dosage}\nQuantity: ${med.quantity}\n\n`
      ).join('');
      
      // Simulate file download
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'medicines.txt';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    function saveRemindersToFile() {
      const reminders = JSON.parse(localStorage.getItem('reminders')) || [];
      const content = reminders.map(rem => 
        `Medicine: ${rem.medicineName}\nDosage: ${rem.dosage}\nTimes: ${rem.times.join(', ')}\nRepeat: ${rem.repeat}\nStart: ${rem.startDate}\nEnd: ${rem.endDate}\nNotes: ${rem.notes}\n\n`
      ).join('');
      
      // Simulate file download
      const blob = new Blob([content], { type: 'text/plain' });
      const url = URL.createObjectURL(blob);
      const a = document.createElement('a');
      a.href = url;
      a.download = 'reminders.txt';
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
    }

    // Initialize the page
    document.addEventListener('DOMContentLoaded', function() {
      checkAuthStatus();
      updateDashboard();
      
      // Set current date as default for date inputs
      const today = new Date().toISOString().split('T')[0];
      document.getElementById('mfg').min = '2000-01-01';
      document.getElementById('mfg').max = today;
      document.getElementById('expiry').min = today;
      
      // Check for reminders every minute
      checkForReminders();
      setInterval(checkForReminders, 60000);
    });
  </script>
</body>
</html>